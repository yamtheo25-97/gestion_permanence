<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Programme de permanence</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="dashboard-body">

    <div class="app-shell">
        <!-- BOUTON HAMBURGER -->
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <aside class="sidebar collapsed" id="sidebar">
            <h3>Navigation</h3>
            <a href="{{ url_for('dashboard') }}">Tableau de bord</a>
            <a href="{{ url_for('menu') }}">Planning</a>
            <a href="{{ url_for('logout') }}">Déconnexion</a>
            
            <hr style="margin:15px 0; border: none; border-top: 1px solid #444;">
            
            <h3>Rotation </h3>
            <div id="rotationInfo">
                <button class="shift-btn" data-guerite="Nord">Nord</button>
                <button class="shift-btn" data-guerite="Sud">Sud</button>
            </div>
            <div id="shiftDetails" style="margin-top:10px; font-size:0.85em; padding:8px; background:#242424; border-radius:4px;">Chargement...</div>
        </aside>

        <div class="main-content">
            <!-- HEADER -->
            <header class="dashboard-header">
                <h1>Programme de permanence — Tableau de bord</h1>
                <p>Bienvenue <strong>{{ prenom }} {{ nom }}</strong></p>
            </header>

            <!-- CONTENU PRINCIPAL -->
            <main class="dashboard-main">

        <!-- PERMANENCES DE L'UTILISATEUR -->
        <h2>Vos permanences</h2>

        {% if user_permanences and user_permanences|length > 0 %}
            <table class="permanences-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Groupe</th>
                        <th>Guérite</th>
                        <th>Service</th>
                        <th>Alerte</th>
                    </tr>
                </thead>
                <tbody>
                    {% for perm in user_permanences %}
                    <tr>
                        <td>{{ perm.date }}</td>
                        <td>{{ perm.display }}</td>
                        <td>Groupe {{ perm.group }}</td>
                        <td>{{ perm.guerite }}</td>
                        <td>
                            {% if perm.service %}
                                <span style="color: #0f0; font-weight: bold;">En service</span>
                            {% else %}
                                <span style="color: #ff0;">En attente</span>
                            {% endif %}
                        </td>
                        <td>{{ perm.alert_time }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="no-permanence">
                Aucune permanence prévue pour vous dans les 30 prochains jours.
            </p>
        {% endif %}

        <h2>Vos alertes de permanence</h2>

        {% if alertes and alertes|length > 0 %}
            <table class="alertes-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Message</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alerte in alertes %}
                    <tr>
                        <td>{{ alerte.get('Date','') }}</td>
                        <td>{{ alerte.get('Heure','') }}</td>
                        <td>{{ alerte.get('Message','') }}</td>
                        <td>
                            <button onclick="stopAlarm()" class="btn-stop" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                Couper l'alarme
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="no-alert">
                Aucune alerte pour le moment.
            </p>
        {% endif %}

            </main>

            <!-- AUDIO ALARME -->
            <audio id="alarmeAudio" src="{{ url_for('static', filename='alarm.wav') }}"></audio>

            <!-- MODAL D'ALERTE -->
            <div id="alertModal">
                <div class="alert-content" id="alertContent">Chargement...</div>
            </div>

            <!-- SCRIPT -->
            <script>
                let alertActive = false;
                const audioEl = document.getElementById('alarmeAudio');
                // stop alarm
                function stopAlarm(){
                    try{
                        // Arrêter l'audio principal
                        if (audioEl){ 
                            audioEl.pause(); 
                            audioEl.currentTime = 0; 
                        }
                    }catch(e){/*ignore*/}
                    
                    // Arrêter le fallback WebAudio
                    try{
                        stopFallback();
                    }catch(e){/*ignore*/}
                    
                    alertActive = false;
                    const modal = document.getElementById('alertModal');
                    if (modal) modal.style.display = 'none';
                }

                // Play alarm with fallback to WebAudio
                function playAlarm(){
                    if (audioEl){
                        audioEl.loop = true;
                        audioEl.play().catch(()=>{
                            // fallback: simple beep
                            try{ window.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                                const o = window.audioCtx.createOscillator();
                                const g = window.audioCtx.createGain();
                                o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.05;
                                o.connect(g); g.connect(window.audioCtx.destination); o.start(); window._osc = o; window._gain=g;
                            }catch(e){}
                        });
                    }else{
                        try{ window.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                            const o = window.audioCtx.createOscillator();
                            const g = window.audioCtx.createGain();
                            o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.05;
                            o.connect(g); g.connect(window.audioCtx.destination); o.start(); window._osc = o; window._gain=g;
                        }catch(e){}
                    }
                }
                function stopFallback(){ if(window._osc){ try{window._osc.stop(); window._osc.disconnect(); window._gain.disconnect(); }catch(e){} window._osc=null; window._gain=null;} }

                async function showAlert(slot){
                    alertActive = true;
                    const modal = document.getElementById('alertModal');
                    if (!modal) return;
                    
                    // Récupérer le nom de l'utilisateur connecté
                    const userName = "{{ prenom }} {{ nom }}".trim();
                    
                    // build members by guérite
                    const byG = {};
                    (slot.members||[]).forEach(m=>{ byG[m.guerite] = byG[m.guerite] || []; byG[m.guerite].push(m); });
                    
                    let html = `<h2>ALERTE — VOTRE SERVICE DANS 30 MIN</h2>`;
                    html += `<p><strong>${userName}</strong> - Groupe ${slot.group}<br>${slot.display}</p>`;
                    
                    // Trouver la guérite de l'utilisateur
                    let userGuerite = null;
                    let userIsService = false;
                    
                    for (const [guerite, members] of Object.entries(byG)) {
                        const userInGuerite = members.find(m => m.name.toLowerCase() === userName.toLowerCase());
                        if (userInGuerite) {
                            userGuerite = guerite;
                            userIsService = userInGuerite.service;
                            break;
                        }
                    }
                    
                    if (userGuerite) {
                        const statusText = userIsService ? "EN SERVICE" : "EN ATTENTE";
                        const statusColor = userIsService ? "#0f0" : "#ff0";
                        html += `<div style="background: #242424; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid ${statusColor};">`;
                        html += `<strong style="color: ${statusColor};">Votre guérite: ${userGuerite}</strong><br>`;
                        html += `<strong style="color: ${statusColor};">${statusText}</strong>`;
                        html += `</div>`;
                    }
                    
                    html += `<button class="stop-alarm-btn" onclick="stopAlarm(); stopFallback();">Couper l'alarme</button>`;
                    document.getElementById('alertContent').innerHTML = html;
                    modal.style.display = 'block';
                    playAlarm();
                }

                // Vérifier si alerte 30min
                async function checkAlert(){
                    try{
                        const res = await fetch("{{ url_for('alert_check') }}");
                        const data = await res.json();
                        if (data.should_alert && !alertActive){
                            console.log('ALERTE DÉTECTÉE - Lancement de l\'alarme');
                            await showAlert(data.slot);
                        }
                    }catch(e){
                        console.error('Erreur lors de la vérification d\'alerte:', e);
                    }
                }

                // Forcer la vérification immédiate au chargement
                async function forceCheckAlert(){
                    console.log('Vérification forcée des alertes...');
                    await checkAlert();
                }

                // Charger infos rotation
                async function loadShiftInfo(){
                    try {
                        const res = await fetch("{{ url_for('current_shift') }}");
                        const data = await res.json();
                        if (!data || !data.group) {
                            document.getElementById('shiftDetails').innerHTML = 'Aucun créneau disponible';
                            return;
                        }
                        let html = `<strong>Groupe ${data.group}</strong><br>`;
                        html += `${data.display}<br><br>`;
                        const byGuerite = {};
                        (data.members || []).forEach(m => { if (!byGuerite[m.guerite]) byGuerite[m.guerite]=[]; byGuerite[m.guerite].push(m.name); });
                        Object.keys(byGuerite).sort().forEach(g => { const isService = (g===data.guerite_service); const style = isService? 'style="color:#0f0"':''; html += `<div ${style}><strong>${g}</strong>: ${byGuerite[g].join(', ')}</div>`; });
                        document.getElementById('shiftDetails').innerHTML = html;
                    } catch(err) { console.error(err); }
                }

                // init
                loadShiftInfo(); 
                setInterval(loadShiftInfo, 30000);
                
                // Vérification des alertes : immédiate puis toutes les 30 secondes
                forceCheckAlert(); 
                setInterval(checkAlert, 30000);
            </script>
            
            <script>
                // Fonction pour basculer la sidebar
                function toggleSidebar() {
                    const sidebar = document.getElementById('sidebar');
                    const hamburgerBtn = document.getElementById('hamburgerBtn');
                    
                    sidebar.classList.toggle('collapsed');
                    hamburgerBtn.classList.toggle('active');
                }
                
                // Fermer la sidebar en cliquant à l'extérieur
                document.addEventListener('click', function(event) {
                    const sidebar = document.getElementById('sidebar');
                    const hamburgerBtn = document.getElementById('hamburgerBtn');
                    
                    if (!sidebar.contains(event.target) && !hamburgerBtn.contains(event.target)) {
                        if (sidebar.classList.contains('collapsed')) {
                            toggleSidebar();
                        }
                    }
                });
            </script>
        </div>
    </div>

</body>
</html> 
